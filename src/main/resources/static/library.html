<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Library - Browse Albums</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: linear-gradient(275deg, #1a1a4d 0%, #000011 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #000;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .nav-links {
            margin-top: 20px;
        }

        .nav-links a {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            transition: background 0.3s;
        }

        .nav-links a:hover {
            background: #764ba2;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .search-box {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .search-input-wrapper {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .search-clear-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            display: none;
            transition: color 0.2s;
            line-height: 1;
        }

        .search-clear-btn:hover {
            color: #667eea;
        }

        .search-clear-btn.visible {
            display: block;
        }

        .search-box input,
        .search-box select {
            flex: 1;
            min-width: 200px;
            padding: 12px;
            padding-right: 40px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 1rem;
        }

        .search-box select {
            padding-right: 12px;
        }

        .search-box button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background 0.3s;
        }

        .search-box button:hover {
            background: #764ba2;
        }

        .stats {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
        }

        .stat-card .label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2rem;
        }

        .error {
            background: #ff4444;
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .albums-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }

        .album-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }


        .album-cover {
            width: 100%;
            height: 250px;
            object-fit: cover;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .album-info {
            padding: 15px;
        }

        .album-title {
            font-size: 1.1rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .album-artist {
            color: #667eea;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .album-details {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }

        .genre-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }

        .genre-tag {
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            color: #555;
        }

        .no-results {
            text-align: center;
            padding: 60px 20px;
            color: white;
            font-size: 1.3rem;
        }

        .no-results p {
            margin-bottom: 20px;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .pagination button {
            padding: 10px 20px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .pagination button:hover:not(:disabled) {
            background: #667eea;
            color: white;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination .current-page {
            background: #667eea;
            color: white;
        }

        footer {
            text-align: center;
            color: white;
            padding: 30px;
            margin-top: 40px;
        }

        @media (max-width: 768px) {
            h1 {
                font-size: 1.8rem;
            }

            .albums-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .album-cover {
                height: 150px;
            }

            .search-box {
                flex-direction: column;
            }

            .search-box input,
            .search-box select {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ Music Library</h1>
            <p style="color: #666; margin-top: 10px;">Browse and explore the album collection</p>
            <div class="nav-links">
                <a href="/index.html">‚Üê Back to Documentation</a>
                <a href="/swagger-ui.html" target="_blank">API Docs</a>
            </div>
        </header>

        <div class="controls">
            <div class="search-box">
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" placeholder="Search albums by title...">
                    <button class="search-clear-btn" id="searchClearBtn" onclick="clearSearchInput()" title="Clear search">‚úï</button>
                </div>
                <select id="artistFilter">
                    <option value="">All Artists</option>
                </select>
                <select id="genreFilter">
                    <option value="">All Genres</option>
                </select>
                <button onclick="searchAlbums()">Search</button>
                <button onclick="clearFilters()" style="background: #999;">Clear</button>
            </div>
            <div class="stats" id="stats">
                <div class="stat-card">
                    <div class="number" id="albumCount">-</div>
                    <div class="label">Albums</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="artistCount">-</div>
                    <div class="label">Artists</div>
                </div>
                <div class="stat-card">
                    <div class="number" id="genreCount">-</div>
                    <div class="label">Genres</div>
                </div>
            </div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            Loading albums...
        </div>

        <div id="error" class="error" style="display: none;"></div>

        <div id="albumsContainer" class="albums-grid"></div>

        <div id="pagination" class="pagination"></div>

        <footer>
            <p>Music Library API - Built with Spring Boot & Java</p>
            <p style="margin-top: 10px; font-size: 0.9rem;">
                <a href="https://github.com/jc-gh25/MusicLibrary" style="color: white;" target="_blank">VIEW ON GITHUB</a>
            </p><br><br>
			<p><i>All images are copyrighted by their respective owners and displayed only for demonstration purposes.</i></p>
        </footer>
    </div>

    <script>
        // API base URL - Automatically detects local vs deployed environment
        const API_BASE = '/api';
        
        // Discogs API configuration - DISABLED (requires authentication)
        const DISCOGS_TOKEN = ''; // Leave empty to disable Discogs lookups
        const DISCOGS_API = 'https://api.discogs.com/database/search';
        const discogsCache = new Map();
        
        // Current page state
        let currentPage = 0;
        let totalPages = 0;
        const pageSize = 20;
        
        // Store current filter state for pagination
        let currentFilters = {
            artistId: '',
            genreId: '',
            searchTerm: ''
        };

        // Load initial data when page loads
        window.addEventListener('DOMContentLoaded', function() {
            loadStats();
            loadArtists();
            loadGenres();
            loadAlbums();
        });

        // Load statistics
        async function loadStats() {
            try {
                const [albums, artists, genres] = await Promise.all([
                    fetch(`${API_BASE}/albums?page=0&size=1`).then(r => r.json()),
                    fetch(`${API_BASE}/artists?page=0&size=1`).then(r => r.json()),
                    fetch(`${API_BASE}/genres?page=0&size=1`).then(r => r.json())
                ]);

                console.log('Stats API responses:', { albums, artists, genres });

                // Extract totalElements from paginated responses with fallbacks
                const albumTotal = albums?.totalElements ?? albums?.total ?? albums?.page?.totalElements ?? (Array.isArray(albums) ? albums.length : 0);
                const artistTotal = artists?.totalElements ?? artists?.total ?? artists?.page?.totalElements ?? (Array.isArray(artists) ? artists.length : 0);
                const genreTotal = genres?.totalElements ?? genres?.total ?? genres?.page?.totalElements ?? (Array.isArray(genres) ? genres.length : 0);

                document.getElementById('albumCount').textContent = albumTotal;
                document.getElementById('artistCount').textContent = artistTotal;
                document.getElementById('genreCount').textContent = genreTotal;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('albumCount').textContent = '0';
                document.getElementById('artistCount').textContent = '0';
                document.getElementById('genreCount').textContent = '0';
            }
        }

        // Load artists for filter dropdown
        async function loadArtists() {
            try {
                const response = await fetch(`${API_BASE}/artists?size=100&sort=name,asc`);
                const data = await response.json();
                
                const select = document.getElementById('artistFilter');
                const artists = data.content || data;
                artists.forEach(artist => {
                    const option = document.createElement('option');
                    option.value = artist.artistId;
                    option.textContent = artist.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading artists:', error);
            }
        }

        // Load genres for filter dropdown
        async function loadGenres() {
            try {
                const response = await fetch(`${API_BASE}/genres?size=100&sort=name,asc`);
                const data = await response.json();
                
                const select = document.getElementById('genreFilter');
                const genres = data.content || data;
                genres.forEach(genre => {
                    const option = document.createElement('option');
                    option.value = genre.genreId;
                    option.textContent = genre.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading genres:', error);
            }
        }

        // Load albums with filters
        async function loadAlbums(page = 0) {
            const loading = document.getElementById('loading');
            const error = document.getElementById('error');
            const container = document.getElementById('albumsContainer');
            
            loading.style.display = 'block';
            error.style.display = 'none';
            container.innerHTML = '';

            try {
                const artistId = document.getElementById('artistFilter').value;
                const genreId = document.getElementById('genreFilter').value;
                const searchTerm = document.getElementById('searchInput').value.trim();

                // Store current filters for pagination
                currentFilters = { artistId, genreId, searchTerm };

                let url;
                let response;
                let data;
                let albums;
                let isPaginated = false;

                // Route to correct endpoint based on filters
                if (artistId) {
                    // Use nested artist endpoint - returns array
                    url = `${API_BASE}/artists/${artistId}/albums`;
                    console.log('Fetching albums by artist:', url);
                    response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    data = await response.json();
                    albums = Array.isArray(data) ? data : [];
                    
                    // Apply genre filter client-side if needed
                    if (genreId) {
                        albums = albums.filter(album => 
                            album.genres && album.genres.some(g => g.genreId == genreId)
                        );
                    }
                    
                    // Apply search filter client-side
                    if (searchTerm) {
                        const term = searchTerm.toLowerCase();
                        albums = albums.filter(album => 
                            album.title.toLowerCase().includes(term)
                        );
                    }
                    
                    // Client-side pagination for array results
                    totalPages = Math.ceil(albums.length / pageSize);
                    currentPage = Math.min(page, Math.max(0, totalPages - 1));
                    const start = currentPage * pageSize;
                    albums = albums.slice(start, start + pageSize);
                    
                } else if (genreId) {
                    // Use nested genre endpoint - returns array
                    url = `${API_BASE}/genres/${genreId}/albums`;
                    console.log('Fetching albums by genre:', url);
                    response = await fetch(url);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    data = await response.json();
                    albums = Array.isArray(data) ? data : [];
                    
                    // Apply search filter client-side
                    if (searchTerm) {
                        const term = searchTerm.toLowerCase();
                        albums = albums.filter(album => 
                            album.title.toLowerCase().includes(term)
                        );
                    }
                    
                    // Client-side pagination for array results
                    totalPages = Math.ceil(albums.length / pageSize);
                    currentPage = Math.min(page, Math.max(0, totalPages - 1));
                    const start = currentPage * pageSize;
                    albums = albums.slice(start, start + pageSize);
                    
                } else {
                    // Use main albums endpoint
                    if (searchTerm) {
                        // When searching, fetch ALL albums to search across entire library
                        url = `${API_BASE}/albums?page=0&size=1000&sort=title,asc`;
                        console.log('Fetching all albums for search:', url);
                        response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        data = await response.json();
                        albums = data.content || [];
                        
                        // Apply search filter client-side
                        const term = searchTerm.toLowerCase();
                        albums = albums.filter(album => 
                            album.title.toLowerCase().includes(term)
                        );
                        
                        // Client-side pagination for filtered results
                        totalPages = Math.ceil(albums.length / pageSize);
                        currentPage = Math.min(page, Math.max(0, totalPages - 1));
                        const start = currentPage * pageSize;
                        albums = albums.slice(start, start + pageSize);
                        isPaginated = false;
                    } else {
                        // No search term - use server-side pagination
                        url = `${API_BASE}/albums?page=${page}&size=${pageSize}&sort=title,asc`;
                        console.log('Fetching all albums:', url);
                        response = await fetch(url);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        data = await response.json();
                        albums = data.content || [];
                        currentPage = data.page.number || 0;
                        totalPages = data.page.totalPages || 0;
                        isPaginated = true;
                    }
                }
                
                loading.style.display = 'none';

                if (albums && albums.length > 0) {
                    displayAlbums(albums);
                    displayPagination(isPaginated ? data : null);
                } else {
                    container.innerHTML = `
                        <div class="no-results">
                            <p>No albums found</p>
                            <p style="font-size: 1rem;">Try adjusting your search filters</p>
                        </div>
                    `;
                    document.getElementById('pagination').innerHTML = '';
                }
            } catch (err) {
                loading.style.display = 'none';
                error.style.display = 'block';
                error.textContent = `Error loading albums: ${err.message}`;
                console.error('Error:', err);
            }
        }

        // Display albums in grid
        function displayAlbums(albums) {
            const container = document.getElementById('albumsContainer');
            container.innerHTML = '';

            albums.forEach(album => {
                const card = createAlbumCard(album);
                container.appendChild(card);
            });
        }

        // Search Discogs API for album images - DISABLED unless token provided
        async function searchDiscogsImage(artist, album) {
            if (!DISCOGS_TOKEN) {
                return null; // Disabled - no token provided
            }
            
            const cacheKey = `${artist}|${album}`;
            
            if (discogsCache.has(cacheKey)) {
                return discogsCache.get(cacheKey);
            }
            
            try {
                const query = `${artist} ${album}`;
                const url = `${DISCOGS_API}?q=${encodeURIComponent(query)}&type=release`;
                
                const response = await fetch(url, {
                    headers: { 
                        'User-Agent': 'MusicLibrary/1.0',
                        'Authorization': `Discogs token=${DISCOGS_TOKEN}`
                    }
                });
                
                if (!response.ok) {
                    console.warn(`Discogs API returned ${response.status}`);
                    discogsCache.set(cacheKey, null);
                    return null;
                }
                
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    for (const result of data.results) {
                        if (result.cover_image && result.cover_image !== 'https://s.discogs.com/images/default-release-cd.png') {
                            discogsCache.set(cacheKey, result.cover_image);
                            return result.cover_image;
                        }
                    }
                }
            } catch (error) {
                console.warn(`Discogs search failed for "${cacheKey}":`, error);
            }
            
            discogsCache.set(cacheKey, null);
            return null;
        }

        // Create album card element
        function createAlbumCard(album) {
            const card = document.createElement('div');
            card.className = 'album-card';
            
            const releaseYear = album.releaseDate ? new Date(album.releaseDate).getFullYear() : 'Unknown';
            
            let genreTags = '';
            if (album.genres && album.genres.length > 0) {
                genreTags = album.genres.map(genre => 
                    `<span class="genre-tag">${genre.name}</span>`
                ).join('');
            }

            const placeholderSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='250'%3E%3Crect fill='%23667eea' width='250' height='250'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='white' font-size='20' dy='.3em'%3ENo Cover%3C/text%3E%3C/svg%3E";
            const imageUrl = album.coverImageUrl || placeholderSvg;
            const artistName = album.artist?.name || 'Unknown Artist';
            const albumTitle = album.title;
            
            card.innerHTML = `
                <img src="${imageUrl}" 
                     alt="${albumTitle}" 
                     class="album-cover"
                     data-artist="${artistName}"
                     data-album="${albumTitle}"
                     onerror="handleImageError(this)">
                <div class="album-info">
                    <div class="album-title" title="${albumTitle}">${albumTitle}</div>
                    <div class="album-artist">${artistName}</div>
                    <div class="album-details">
                        üìÖ ${releaseYear} ‚Ä¢ üéµ ${album.trackCount || 0} tracks
                    </div>
                    ${genreTags ? `<div class="genre-tags">${genreTags}</div>` : ''}
                </div>
            `;

            return card;
        }

        // Handle image load errors with fallback
        async function handleImageError(imgElement) {
            imgElement.onerror = null;
            
            if (imgElement.dataset.retried === 'true') {
                const placeholderSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='250'%3E%3Crect fill='%23667eea' width='250' height='250'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='white' font-size='20' dy='.3em'%3ENo Cover%3C/text%3E%3C/svg%3E";
                imgElement.src = placeholderSvg;
                return;
            }
            
            imgElement.dataset.retried = 'true';
            
            const artist = imgElement.dataset.artist;
            const album = imgElement.dataset.album;
            
            // Try Discogs only if token is configured
            if (DISCOGS_TOKEN) {
                const discogsUrl = await searchDiscogsImage(artist, album);
                if (discogsUrl) {
                    imgElement.onerror = function() {
                        this.onerror = null;
                        const placeholderSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='250'%3E%3Crect fill='%23667eea' width='250' height='250'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='white' font-size='20' dy='.3em'%3ENo Cover%3C/text%3E%3C/svg%3E";
                        this.src = placeholderSvg;
                    };
                    imgElement.src = discogsUrl;
                    return;
                }
            }
            
            // Fallback to placeholder
            const placeholderSvg = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='250' height='250'%3E%3Crect fill='%23667eea' width='250' height='250'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' fill='white' font-size='20' dy='.3em'%3ENo Cover%3C/text%3E%3C/svg%3E";
            imgElement.src = placeholderSvg;
        }

        // Display pagination controls
        function displayPagination(data) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Always show pagination controls
            const isFirstPage = currentPage === 0;
            const isLastPage = currentPage >= totalPages - 1;

            // Previous button
            const prevBtn = document.createElement('button');
            prevBtn.textContent = '‚Üê Previous';
            prevBtn.disabled = isFirstPage;
            prevBtn.onclick = () => loadAlbums(currentPage - 1);
            pagination.appendChild(prevBtn);

            // Page info
            const pageInfo = document.createElement('button');
            pageInfo.textContent = `Page ${currentPage + 1} of ${totalPages}`;
            pageInfo.className = 'current-page';
            pageInfo.disabled = true;
            pagination.appendChild(pageInfo);

            // Next button
            const nextBtn = document.createElement('button');
            nextBtn.textContent = 'Next ‚Üí';
            nextBtn.disabled = isLastPage;
            nextBtn.onclick = () => loadAlbums(currentPage + 1);
            pagination.appendChild(nextBtn);
        }

        // Search albums (resets to page 0)
        function searchAlbums() {
            currentPage = 0;
            loadAlbums(0);
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('artistFilter').value = '';
            document.getElementById('genreFilter').value = '';
            currentPage = 0;
            loadAlbums(0);
        }

        // Clear search input and reload albums
        function clearSearchInput() {
            document.getElementById('searchInput').value = '';
            toggleClearButton();
            currentPage = 0;
            loadAlbums(0);
        }

        // Toggle clear button visibility based on input content
        function toggleClearButton() {
            const searchInput = document.getElementById('searchInput');
            const clearBtn = document.getElementById('searchClearBtn');
            
            if (searchInput.value.trim().length > 0) {
                clearBtn.classList.add('visible');
            } else {
                clearBtn.classList.remove('visible');
            }
        }

        // Allow Enter key to trigger search
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchAlbums();
            }
        });

        // Monitor search input for changes to show/hide clear button
        document.getElementById('searchInput').addEventListener('input', toggleClearButton);

        // Initialize clear button state on page load
        window.addEventListener('DOMContentLoaded', function() {
            toggleClearButton();
        });
    </script>
</body>
</html>